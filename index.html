<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>SkyCast – Weather Intelligence</title>
<meta name="description" content="AI-powered weather, radar, forecasts & alerts">

<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/icons/favicon-32.png">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXX"
  crossorigin="anonymous"></script>

<style>
body{font-family:Inter,system-ui;background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff}
.glass{background:rgba(255,255,255,.08);backdrop-filter:blur(12px);border-radius:1.25rem;border:1px solid rgba(255,255,255,.15)}
#map{height:320px;border-radius:1rem}
</style>
</head>

<body class="p-4 md:p-8">
<div class="max-w-7xl mx-auto space-y-6">

<header class="flex justify-between items-center">
<h1 class="text-2xl font-bold flex items-center gap-2">
<i data-lucide="cloud-sun"></i> SkyCast
</h1>
<div class="flex gap-2">
<input id="cityInput" placeholder="Add city" class="glass px-3 py-2">
<button id="addBtn" class="glass px-3 py-2">+</button>
</div>
</header>

<div id="cityTabs" class="flex gap-2 overflow-x-auto"></div>

<div class="grid lg:grid-cols-3 gap-6">
<div class="glass p-6 text-center">
<h2 id="cityName">Detecting location…</h2>
<p id="temp" class="text-6xl font-bold">--°</p>
<p id="desc" class="text-blue-300"></p>
</div>

<div class="glass p-6">
<h3 class="font-semibold mb-2">AI Forecast (GPT-4)</h3>
<p id="aiText" class="text-sm text-gray-300">Generating insight…</p>
</div>

<div id="alertBox" class="glass p-6 hidden">
<p class="text-red-400 font-bold">⚠ Government Alert</p>
<p id="alertText"></p>
</div>
</div>

<!-- HOURLY -->
<div class="glass p-4">
<h3 class="font-semibold mb-2">Hourly Forecast</h3>
<div id="hourly" class="flex gap-3 overflow-x-auto"></div>
</div>

<!-- DAILY -->
<div class="glass p-4">
<h3 class="font-semibold mb-2">7-Day Forecast</h3>
<div id="daily" class="space-y-2"></div>
</div>

<div class="glass p-4">
<h3 class="font-semibold mb-2">Live Weather Radar</h3>
<div id="map"></div>
</div>

<footer class="text-center text-xs text-gray-500 pt-8">
© 2025 SkyCast Weather Intelligence
</footer>

</div>

<script>
lucide.createIcons();
const $=id=>document.getElementById(id);
let map,marker,radar;
let cities=JSON.parse(localStorage.getItem("cities"))||[];

$("addBtn").onclick=()=>{
const v=cityInput.value.trim();
if(!v)return;
cities.push(v);
localStorage.setItem("cities",JSON.stringify(cities));
cityInput.value="";
renderTabs();
loadCity(v);
};

function renderTabs(){
cityTabs.innerHTML="";
cities.forEach(c=>{
const b=document.createElement("button");
b.className="glass px-3 py-1";
b.textContent=c;
b.onclick=()=>loadCity(c);
cityTabs.appendChild(b);
});
}

async function detectLocation(){
return new Promise(res=>{
navigator.geolocation?.getCurrentPosition(async p=>{
const lat=p.coords.latitude,lon=p.coords.longitude;
res({city:"Your Location",lat,lon});
},()=>res({city:"New Delhi",lat:28.61,lon:77.2}));
});
}

function initMap(){
map=L.map("map").setView([20,77],5);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);
}

async function loadCity(city){
const g=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`).then(r=>r.json());
if(!g.results?.length)return;
loadWeather(g.results[0].latitude,g.results[0].longitude,city);
}

async function loadWeather(lat,lon,label){
cityName.textContent=label;

const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=auto`).then(r=>r.json());

temp.textContent=Math.round(w.current.temperature_2m)+"°";
desc.textContent=descText(w.current.weather_code);

renderHourly(w);
renderDaily(w);
updateMap(lat,lon);
generateAI(w,label);
}

function renderHourly(w){
hourly.innerHTML="";
for(let i=0;i<24;i++){
const h=new Date(w.hourly.time[i]).getHours();
hourly.innerHTML+=`
<div class="glass px-3 py-2 text-center min-w-[80px]">
<p class="text-xs">${h}:00</p>
<p class="font-bold">${Math.round(w.hourly.temperature_2m[i])}°</p>
</div>`;
}
}

function renderDaily(w){
daily.innerHTML="";
for(let i=0;i<7;i++){
const d=new Date(w.daily.time[i]).toLocaleDateString(undefined,{weekday:"short"});
daily.innerHTML+=`
<div class="glass px-3 py-2 flex justify-between">
<span>${d}</span>
<span>${Math.round(w.daily.temperature_2m_max[i])}° / ${Math.round(w.daily.temperature_2m_min[i])}°</span>
</div>`;
}
}

async function generateAI(w,city){
try{
const r=await fetch("/api/ai-forecast",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({
city,
temp:w.current.temperature_2m,
code:descText(w.current.weather_code)
})});
const d=await r.json();
aiText.textContent=d.text;
}catch{
aiText.textContent="AI forecast unavailable.";
}
}

function updateMap(lat,lon){
map.setView([lat,lon],8);
marker?marker.setLatLng([lat,lon]):marker=L.marker([lat,lon]).addTo(map);
}

function descText(c){
return{0:"Clear",1:"Partly Cloudy",2:"Cloudy",61:"Rain",71:"Snow",95:"Thunderstorm"}[c]||"Weather";
}

(async()=>{
initMap();
const loc=await detectLocation();
if(!cities.length){cities=[loc.city];localStorage.setItem("cities",JSON.stringify(cities));}
renderTabs();
loadWeather(loc.lat,loc.lon,loc.city);
})();
</script>
</body>
</html>
