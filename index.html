<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>SkyCast â€“ Weather Intelligence</title>
<meta name="description" content="AI-powered weather, radar, forecasts & alerts">

<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/icons/favicon-32.png">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Google AdSense -->
<script async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXX"
  crossorigin="anonymous"></script>

<style>
body {
  font-family: Inter, system-ui;
  background: linear-gradient(135deg,#0f172a,#1e293b);
  color: white;
}
.glass {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(14px);
  border-radius: 1.25rem;
  border: 1px solid rgba(255,255,255,0.15);
}
#map { height: 320px; border-radius: 1rem; }
#weatherCanvas {
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
}
</style>
</head>

<body class="p-4 md:p-8">
<canvas id="weatherCanvas"></canvas>

<div class="max-w-7xl mx-auto space-y-6">

<header class="flex justify-between items-center">
<h1 class="text-2xl font-bold flex items-center gap-2">
<i data-lucide="cloud-sun"></i> SkyCast
</h1>
<div class="flex gap-2">
<input id="cityInput" placeholder="Add city" class="glass px-3 py-2">
<button id="addBtn" class="glass px-3 py-2">+</button>
</div>
</header>

<!-- ADS -->
<div id="webHeaderAd" class="glass p-3 text-center hidden">
<ins class="adsbygoogle" style="display:block"
data-ad-client="ca-pub-XXXXXXXXXXXX"
data-ad-slot="1111111111" data-ad-format="auto"></ins>
</div>

<div id="cityTabs" class="flex gap-2 overflow-x-auto"></div>

<!-- HERO -->
<div class="glass p-8 grid md:grid-cols-2 gap-6">
<div>
<h2 id="cityName">Detecting locationâ€¦</h2>
<p id="temp" class="text-6xl font-bold">--Â°</p>
<p id="desc" class="text-blue-300"></p>
<p id="localTime" class="text-sm text-gray-400"></p>
</div>

<div class="grid grid-cols-2 gap-4">
<div class="glass p-3">ğŸ’§ Humidity <p id="humidity">--%</p></div>
<div class="glass p-3">ğŸŒ¬ Wind <p id="wind">-- km/h</p><p id="windDir"></p></div>
<div class="glass p-3">â˜€ UV <p id="uv">--</p></div>
<div class="glass p-3">ğŸ« PM2.5 <p id="aqi">--</p></div>
</div>
</div>

<div class="grid lg:grid-cols-2 gap-6">
<div class="glass p-6">
<h3>AI Forecast</h3>
<p id="aiText">Generatingâ€¦</p>
</div>
<div class="glass p-6">
<h3>Health Advisory</h3>
<p id="healthAdvice">Analyzingâ€¦</p>
<button id="voiceBtn">ğŸ”Š Read</button>
</div>
</div>

<!-- HOURLY -->
<div class="glass p-4">
<h3>Hourly Forecast</h3>
<div id="hourlyStrip" class="flex gap-4 overflow-x-auto"></div>
</div>

<!-- DAILY -->
<div class="glass p-4">
<h3>7-Day Forecast</h3>
<div id="daily"></div>
</div>

<div class="glass p-4">
<h3>Live Radar</h3>
<div id="map"></div>
</div>

<footer class="text-center text-xs text-gray-500 pt-8">
Â© 2025 SkyCast Weather Intelligence
</footer>

</div>

<script>
lucide.createIcons();
const $=id=>document.getElementById(id);
let map,marker;

/* MAP */
function initMap(){
map=L.map("map").setView([20,77],5);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);
}

/* LOCATION */
function detectLocation(){
return new Promise(r=>{
navigator.geolocation.getCurrentPosition(
p=>r({city:"Your Location",lat:p.coords.latitude,lon:p.coords.longitude}),
()=>r({city:"New Delhi",lat:28.61,lon:77.2})
);
});
}

/* AIR QUALITY (FIXED) */
async function loadAir(lat,lon){
try{
const a=await fetch(
`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5`
).then(r=>r.json());
const pm=Math.round(a.hourly.pm2_5[0]);
aqi.textContent=pm;
return pm;
}catch{aqi.textContent="--";return 0;}
}

/* WEATHER (FIXED) */
async function loadWeather(lat,lon,city){
cityName.textContent=city;

const w=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}
&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,is_day
&hourly=time,temperature_2m,weather_code
&daily=time,temperature_2m_max,temperature_2m_min,uv_index_max
&timezone=auto`
).then(r=>r.json());

temp.textContent=Math.round(w.current.temperature_2m)+"Â°";
desc.textContent=descText(w.current.weather_code);
humidity.textContent=w.current.relative_humidity_2m+"%";
wind.textContent=w.current.wind_speed_10m+" km/h";
windDir.textContent=windDirText(w.current.wind_direction_10m);
uv.textContent=w.daily.uv_index_max[0];
localTime.textContent=new Date().toLocaleTimeString();

renderHourly(w);
renderDaily(w);
updateMap(lat,lon);
applyCanvasWeather(w.current.weather_code);
generateAI(w,city);

const pm=await loadAir(lat,lon);
generateHealth(w,pm);
}

/* UI RENDER */
function renderHourly(w){
hourlyStrip.innerHTML="";
for(let i=0;i<24;i++){
const h=new Date(w.hourly.time[i]).getHours();
hourlyStrip.innerHTML+=`<div class="glass p-3">${h}:00<br>${Math.round(w.hourly.temperature_2m[i])}Â°</div>`;
}
}

function renderDaily(w){
daily.innerHTML="";
for(let i=0;i<7;i++){
const d=new Date(w.daily.time[i]).toLocaleDateString(undefined,{weekday:"short"});
daily.innerHTML+=`<div class="glass p-2 flex justify-between"><span>${d}</span><span>${Math.round(w.daily.temperature_2m_max[i])}Â° / ${Math.round(w.daily.temperature_2m_min[i])}Â°</span></div>`;
}
}

/* AI */
async function generateAI(w,city){
try{
const r=await fetch("/api/ai-forecast",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({city,temp:w.current.temperature_2m,code:descText(w.current.weather_code)})});
const d=await r.json();
aiText.textContent=d.text;
}catch{aiText.textContent="AI unavailable";}
}

/* HEALTH */
function generateHealth(w,pm){
let t=[];
if(pm>60)t.push("High pollution. Avoid outdoor activity.");
if(w.daily.uv_index_max[0]>7)t.push("High UV. Use sunscreen.");
healthAdvice.textContent=t.join(" ")||"Conditions are safe.";
}
voiceBtn.onclick=()=>speechSynthesis.speak(new SpeechSynthesisUtterance(healthAdvice.textContent));

/* HELPERS */
function descText(c){return{0:"Clear",1:"Partly Cloudy",2:"Cloudy",61:"Rain",71:"Snow",95:"Thunderstorm"}[c]||"Weather";}
function windDirText(d){return["N","NE","E","SE","S","SW","W","NW"][Math.round(d/45)%8];}

/* CANVAS */
const canvas=$("weatherCanvas"),ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();addEventListener("resize",resize);
let particles=[],mode="clear";
function applyCanvasWeather(c){
mode=c<=3?"cloud":c<=67?"rain":c<=77?"snow":"clear";
particles=[...Array(120)].map(()=>({x:Math.random()*canvas.width,y:Math.random()*canvas.height,s:Math.random()*2+1}));
}
(function anim(){
ctx.clearRect(0,0,canvas.width,canvas.height);
particles.forEach(p=>{
ctx.fillStyle="rgba(255,255,255,.7)";
if(mode==="rain"){ctx.fillRect(p.x,p.y,2,10);p.y+=p.s*4;}
if(mode==="snow"){ctx.beginPath();ctx.arc(p.x,p.y,2,0,6.28);ctx.fill();p.y+=p.s;}
if(p.y>canvas.height)p.y=0;
});
requestAnimationFrame(anim);
})();

/* INIT */
(async()=>{
initMap();
const loc=await detectLocation();
loadWeather(loc.lat,loc.lon,loc.city);
})();
</script>
</body>
</html>
